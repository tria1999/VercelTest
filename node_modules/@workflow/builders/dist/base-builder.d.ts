import * as esbuild from 'esbuild';
import type { WorkflowManifest } from './apply-swc-transform.js';
import type { WorkflowConfig } from './types.js';
/**
 * Base class for workflow builders. Provides common build logic for transforming
 * workflow source files into deployable bundles using esbuild and SWC.
 *
 * Subclasses must implement the build() method to define builder-specific logic.
 */
export declare abstract class BaseBuilder {
    protected config: WorkflowConfig;
    constructor(config: WorkflowConfig);
    /**
     * Performs the complete build process for workflows.
     * Subclasses must implement this to define their specific build steps.
     */
    abstract build(): Promise<void>;
    /**
     * Finds tsconfig.json/jsconfig.json for the project.
     * Used by esbuild to properly resolve module imports during bundling.
     */
    protected findTsConfigPath(): Promise<string | undefined>;
    /**
     * Discovers all source files in the configured directories.
     * Searches for TypeScript and JavaScript files while excluding common build
     * and dependency directories.
     */
    protected getInputFiles(): Promise<string[]>;
    /**
     * Caches discovered workflow entries by input array reference.
     * Uses WeakMap to allow garbage collection when input arrays are no longer referenced.
     * This cache is invalidated automatically when the inputs array reference changes
     * (e.g., when files are added/removed during watch mode).
     */
    private discoveredEntries;
    protected discoverEntries(inputs: string[], outdir: string): Promise<{
        discoveredSteps: string[];
        discoveredWorkflows: string[];
    }>;
    /**
     * Writes debug information to a JSON file for troubleshooting build issues.
     * Uses atomic write (temp file + rename) to prevent race conditions when
     * multiple builds run concurrently.
     */
    private writeDebugFile;
    /**
     * Logs and optionally throws on esbuild errors and warnings.
     * @param throwOnError - If true, throws an error when esbuild errors are present
     */
    private logEsbuildMessages;
    /**
     * Creates a bundle for workflow step functions.
     * Steps have full Node.js runtime access and handle side effects, API calls, etc.
     *
     * @param externalizeNonSteps - If true, only bundles step entry points and externalizes other code
     * @returns Build context (for watch mode) and the collected workflow manifest
     */
    protected createStepsBundle({ inputFiles, format, outfile, externalizeNonSteps, tsconfigPath, }: {
        tsconfigPath?: string;
        inputFiles: string[];
        outfile: string;
        format?: 'cjs' | 'esm';
        externalizeNonSteps?: boolean;
    }): Promise<{
        context: esbuild.BuildContext | undefined;
        manifest: WorkflowManifest;
    }>;
    /**
     * Creates a bundle for workflow orchestration functions.
     * Workflows run in a sandboxed VM and coordinate step execution.
     *
     * @param bundleFinalOutput - If false, skips the final bundling step (used by Next.js)
     */
    protected createWorkflowsBundle({ inputFiles, format, outfile, bundleFinalOutput, tsconfigPath, }: {
        tsconfigPath?: string;
        inputFiles: string[];
        outfile: string;
        format?: 'cjs' | 'esm';
        bundleFinalOutput?: boolean;
    }): Promise<void | {
        interimBundleCtx: esbuild.BuildContext;
        bundleFinal: (interimBundleResult: string) => Promise<void>;
    }>;
    /**
     * Creates a client library bundle for workflow execution.
     * The client library allows importing and calling workflows from application code.
     * Only generated if clientBundlePath is specified in config.
     */
    protected createClientLibrary(): Promise<void>;
    /**
     * Creates a webhook handler bundle for resuming workflows via HTTP callbacks.
     *
     * @param bundle - If true, bundles dependencies (needed for Build Output API)
     */
    protected createWebhookBundle({ outfile, bundle, }: {
        outfile: string;
        bundle?: boolean;
    }): Promise<void>;
    /**
     * Creates a package.json file with the specified module type.
     */
    protected createPackageJson(dir: string, type: 'commonjs' | 'module'): Promise<void>;
    /**
     * Creates a .vc-config.json file for Vercel Build Output API functions.
     */
    protected createVcConfig(dir: string, config: {
        runtime?: string;
        handler?: string;
        launcherType?: string;
        architecture?: string;
        shouldAddHelpers?: boolean;
        shouldAddSourcemapSupport?: boolean;
        experimentalTriggers?: Array<{
            type: string;
            topic: string;
            consumer: string;
            maxDeliveries?: number;
            retryAfterSeconds?: number;
            initialDelaySeconds?: number;
        }>;
    }): Promise<void>;
    /**
     * Resolves a path relative to the working directory.
     */
    protected resolvePath(path: string): string;
    /**
     * Ensures the directory for a file path exists, creating it if necessary.
     */
    protected ensureDirectory(filePath: string): Promise<void>;
    private createSwcGitignore;
    /**
     * Creates a manifest JSON file containing step/workflow metadata
     * and graph data for visualization.
     */
    protected createManifest({ workflowBundlePath, manifestDir, manifest, }: {
        workflowBundlePath: string;
        manifestDir: string;
        manifest: WorkflowManifest;
    }): Promise<void>;
    private convertStepsManifest;
    private convertWorkflowsManifest;
}
//# sourceMappingURL=base-builder.d.ts.map